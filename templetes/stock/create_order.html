{% extends 'base.html' %}
{% load static %}
{% block title %} Create Bill {% endblock %}

{% block content %}
<style>

.bill-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
    font-family: Arial, sans-serif;
}


.bill-box, .product-box {
    flex: 1;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}


.bill-box h2, .product-box h2 {
    margin-bottom: 15px;
    color: #333;
    font-size: 18px;
}
.product-box h2 {
    margin-top: auto;
    margin-bottom: 15px;
    color: #333;
    font-size: 30px;
}

.bill-box label, .product-box label {
    display: block;
    margin-top: 10px;
    font-size: 14px;
    color: #555;
}


.bill-box input, .product-box input,
.bill-box select, .product-box select {
    width: 100%;
    padding: 8px 10px;
    margin: 5px 0 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
}

.bill-box input:focus, .product-box input:focus,
.bill-box select:focus, .product-box select:focus {
    border-color: #007BFF;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}


.product-box button {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.product-box button:hover {
    background-color: #0056b3;
}

table{
    margin-bottom: 20px;
}
#export{
    display: none;
     margin-top: 10px;
    padding: 8px 12px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
}
#clear{
    display: none;
     margin-top: 10px;
    padding: 8px 12px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
}

.deleteProduct {
  background-color: #007BFF;
  color: white;            
  border: none;             
  padding: 10px 15px;     
  text-align: center;     
  text-decoration: none;
  display: inline-block;
  font-size: 14px;         
  margin: 5px 0;            
  cursor: pointer;          
  border-radius: 5px;     
}




    /* Popup styles */
    .popup {
        position: fixed;
        bottom: 20px;
        right: -300px;
        z-index: 1000;
        background-color: rgba(204, 201, 219, 0.9);
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        display: none;
        border: 3px solid transparent;
        position: relative;
    }

    .popup.show {
        display: block;
        animation: slideIn 0.5s ease forwards;
    }

    .popup.hide {
        animation: slideOut 0.5s ease forwards;
    }

    .popup-content {
        font-size: 16px;
    }

    .popup-content.success {
        color: green;
    }

    .popup-content.error {
        color: red;
    }

    .popup-content.info {
        color: blue;
    }

    @keyframes slideIn {
        from {
            transform: translateX(300px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(300px);
            opacity: 0;
        }
    }
</style>

<!-- Popup -->
<div id="popup-message" class="popup"></div>



    <h1>Create Order</h1>

    <!-- Order Form -->
    <form id="order-form">
        {% csrf_token %}
        <h2>Order Details</h2>
        {{ form.as_p }}
        <button type="submit">Create Order</button>
    </form>

    <hr>

    <!-- Product Form -->
    <div id="product-section" style="display: none;">
        <h2>Add Products to Order</h2>
        <form id="add-product-form">
            {% csrf_token %}
            {{ product_form.as_p }}
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" value="1" required>
            <label for="rate">Rate:</label>
            <input type="number" id="rate" name="rate" step="0.01" value="0.00" required>
            <button type="submit">Add Product</button>
        </form>

        

    </div>
    <hr>

    <!-- Bill Summary -->
    <h2>Bill Summary</h2>
    <table border="1" id="OrderTable">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Product rows will be added dynamically -->
        </tbody>
    </table>
    
    <button type="button" id="clear">Clear</button>



    <script>

function showPopup(type, message) {
        const popup = $('#popup-message');
        popup.html(`<div class="popup-content ${type}">${message}</div>`);
        popup.removeClass('hide').addClass('show').show();

        setTimeout(() => {
            popup.removeClass('show').addClass('hide');
            setTimeout(() => popup.hide(), 500);
        }, 3000);
    }


        $(document).ready(function () {
            let orderId = null;

            // Handle Order Form Submission
            $('#order-form').on('submit', function (e) {
                e.preventDefault();

                $.ajax({
                    url: '',
                    type: 'POST',
                    data: $(this).serialize() + '&order_submit=1',
                    success: function (response) {
                        if (response.success) {
                            orderId = response.order_id;
                            alert('Order created successfully! Order ID: ' + orderId);
                            $('#order-form').hide();
                            $('#product-section').show();
                            $('#add-product-form').data('order-id', orderId); // Store the order ID
                        } else {
                            alert('Error creating order: ' + JSON.stringify(response.errors));
                        }
                    }
                });
            });

            // Handle Product Form Submission
            $('#add-product-form').on('submit', function (e) {
                e.preventDefault();

                const data = {
                    product_name: $('#id_name').val(),
                    hs_code: $('#id_HS_code').val(),
                    quantity: $('#quantity').val(),
                    rate: $('#rate').val(),
                };

                $.ajax({
    url: `/stock/add-order-product/${orderId}/`, // Add product to the created order
    type: 'POST',
    data: JSON.stringify(data),
    contentType: 'application/json',
    success: function (response) {
        if (response.success) {
            $('#OrderTable tbody').append(`
                <tr>
                    <td>${response.product.name}</td>
                    <td>${response.product.quantity}</td>
                    <td>${response.product.rate}</td>
                    <td>${response.product.subtotal}</td>
                    <td><button class="deleteProduct">Delete</button></td>
                </tr>
            `);
            showPopup('success', 'Product added successfully!');
        } else {
            showPopup('error', 'Error adding product: ' + response.error);
        }
    },
    error: function () {
        showPopup('error', 'An error occurred while adding the product.');
    }
});
            });
            
        
        });
    </script>
{% endblock %}