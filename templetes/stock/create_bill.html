{% extends 'base.html' %}
{% load static %}
{% block title %} Create Bill {% endblock %}

{% block content %}
<style>
    /* Popup container */
    .popup {
        position: fixed;
        bottom: 20px; /* Positioned at the bottom-right corner */
        right: -300px; /* Start off-screen to the right */
        z-index: 1000;
        background-color: rgba(204, 201, 219, 0.9);
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        display: none; /* Initially hidden */
        border: 3px solid transparent; /* Placeholder for border loading effect */
        position: relative; /* Necessary for the pseudo-element */
    }

    /* Show popup with slide-in animation */
    .popup.show {
        display: block;
        animation: slideIn 0.5s ease forwards; /* Slide-in animation */
    }

    /* Hide popup with slide-out animation */
    .popup.hide {
        animation: slideOut 0.5s ease forwards; /* Slide-out animation */
    }

    /* Popup content styles */
    .popup-content {
        color: #9da6ce;
        font-size: 16px;
    }

    .popup-content.success {
        color: green;
    }

    .popup-content.error {
        color: rgb(240, 6, 6);
    }

    .popup-content.info {
        color: blue;
    }

    .popup-content.warning {
        color: orange;
    }

    /* Slide-in animation */
    @keyframes slideIn {
        from {
            transform: translateX(300px); /* Slide in from the right */
            opacity: 0; /* Start fully transparent */
        }
        to {
            transform: translateX(0); /* Slide into the final position */
            opacity: 1; /* Fully visible */
        }
    }

    /* Slide-out animation */
    @keyframes slideOut {
        from {
            transform: translateX(0); /* Start in the visible position */
            opacity: 1; /* Fully visible */
        }
        to {
            transform: translateX(300px); /* Slide out to the right */
            opacity: 0; /* Fully transparent */
        }
    }
</style>

<!-- Always include the popup container, even if there are no messages -->
<div id="popup-message" class="popup"></div>

<h1>Create Bill</h1>

<!-- Bill Form -->
<form id="billForm">
    <label for="customer">Customer:</label>
    <select id="customer" name="customer_id" required>
        <option value="" disabled selected>Select a customer</option>
        {% for customer in customers %}
        <option value="{{ customer.id }}">{{ customer.name }}</option>
        {% endfor %}
    </select>
    <input type="number" id="bill_no" name="bill_no" value="" placeholder="Enter Bill Number" required>
    <input type="number" id="discount" name="discount" value="" placeholder="Discount Rate" required>
    <input type="hidden" id="bill_id" name="bill_id" value="">

    <h2>Add Product</h2>
    <label for="product">Product:</label>
    <select id="product" name="product_id" required>
        <option value="" disabled selected>Select a product</option>
        {% for product in products %}
        <option value="{{ product.id }}">{{ product.name }}</option>
        {% endfor %}
    </select>

    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1" required>

    <label for="rate">Rate:</label>
    <input type="number" id="rate" name="rate" step="0.01" required>

    <button type="button" id="addProduct">Add Product</button>
    
</form>

<hr>

<!-- Section to Display Bill Items -->
<h2>Bill Summary</h2>
<table border="1" id="billTable">
    <thead>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Rate</th>
            <th>Subtotal</th>
        </tr>
    </thead>
    <tbody>
        <!-- Dynamically added rows will appear here -->
    </tbody>
    <tfoot>
        <tr>
            <td colspan="3"><strong>Total:</strong></td>
            <td id="billTotal">0.00</td>
        </tr>
    </tfoot>
</table>

<!-- Export Button -->
<button type="button" id="export" style="display: none;">Export as PDF</button>
<button type="button" id="clear" style="display: none;">Clear</button>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Function to show the popup
    function showPopup(messageType, messageText) {
        // Check if the popup exists
        const popup = document.getElementById("popup-message");
        popup.innerHTML = ''; // Clear existing content
        // Create the message div and set its class and text
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('popup-content', messageType);  // Add class for styling (success, error, etc.)
        messageDiv.innerText = messageText;

        // Append the message div to the popup
        popup.appendChild(messageDiv);

        popup.classList.remove('hide');
    popup.style.display = "block";

        // Show the popup with slide-in animation
        popup.classList.add('show');
        
        // After 3 seconds, hide the popup with slide-out animation
        setTimeout(() => {
            popup.classList.remove('show');
            popup.classList.add('hide');
            // After animation finishes, hide the popup container
            setTimeout(() => {
                popup.style.display = "none";  // Hides the popup after slide-out
            }, 500); 
        }, 3000); // Adjust this time to control how long the popup stays visible
    }

  

    $('#addProduct').on('click', function () {
        const billId = $('#bill_id').val();
        const bill_no = $('#bill_no').val();
        const discount = $('#discount').val();
        const customerId = $('#customer').val();
        const productId = $('#product').val();
        const quantity = $('#quantity').val();
        const rate = $('#rate').val();

        $.ajax({
            url: '{% url "add_bill_item_ajax" %}',
            method: 'POST',
            data: {
                bill_id: billId,
                bill_no: bill_no,
                customer_id: customerId,
                product_id: productId,
                discount:discount,
                quantity: quantity,
                rate: rate,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                if (!billId) {
                    $('#bill_id').val(response.bill_id);
                    $('#export').show();
                    $('#clear').show();
                }

                // Add product to the bill table
                $('#billTable tbody').append(`
                    <tr>
                        <td>${response.product_name}</td>
                        <td>${response.quantity}</td>
                        <td>${response.rate}</td>
                        <td>${response.subtotal.toFixed(2)}</td>
                    </tr>
                `);

                // Update total
                $('#billTotal').text(response.total.toFixed(2));
                showPopup('success', 'Product added to bill successfully');
            },
            error: function (xhr, status, error) {
                console.error('Error:', error); // Log the error to the console
                showPopup('error', 'Failed to add product. Please try again.');
            }
        });
    });
    $('#export').on('click', function () {
    const billID = $('#bill_id').val(); // Capture the bill ID

    if (!billID) {
        alert('Please ensure the bill ID is correct.');
        return;
    }

    // Trigger PDF export with the correct URL
    window.location.href = `/stock/bills/pdf/${billID}/`;
});


$('#clear').on('click', function () {
            // Reset all input fields
            $('#billForm')[0].reset();

            // Clear the table
            $('#billTable tbody').empty();
            $('#billTotal').text('0.00');

            // Hide export button
            $('#export').hide();
            $('#clear').hide();
            // Clear hidden bill ID
            $('#bill_id').val('');
        });
</script>

{% endblock %}
